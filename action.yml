name: Tests (Conan)

inputs:
  directory:
    description: Directory to change into
    required: true

runs:
  using: composite
  strategy:
    fail-fast: false
    matrix:
      config:
        - { cc: "gcc", cxx: "g++" }

  steps:
    - name: Checkout
      uses: actions/checkout@v4
      run: |
        cd ${{ inputs.directory }}

    - name: Restore ccache caches
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ github.job }}

    - name: Conan cache
      uses: actions/cache@v4
      with:
        path: ~/.conan/data
        key: conan-${{ runner.os }}-${{ hashFiles('**/conanfile.py') }}

    - name: apt cache
      uses: actions/cache@v4
      with:
        path: |
          /var/cache/apt/
          /var/lib/apt/
        key: apt-${{ runner.os }}-${{ github.job }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"

    - name: Set up pipx
      run: |
        python -m pip install --user pipx
        python -m pipx ensurepath

    - name: Set up Conan
      run: |
        pipx install cmake
        pipx install conan

    - name: Install compilers
      run: sudo apt install build-essential ninja-build

    - name: Set Conan remote
      run: |
        conan profile detect
        conan remote add ostis-ai https://conan.ostis.net/artifactory/api/conan/ostis-ai-sc-machine/

    - name: Install C++ problem solver dependencies
      run: conan install . --build=missing

    - name: Build component with tests
      id: run_cmake
      run: |
        cmake --preset release-with-tests-conan
        cmake --build --preset release

    - name: Run component tests
      id: run_tests
      run: cd build/Release && ctest -V
